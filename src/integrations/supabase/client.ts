
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://vtaufnxworztolfdwlll.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0YXVmbnh3b3J6dG9sZmR3bGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA4ODIwMjUsImV4cCI6MjA1NjQ1ODAyNX0.O_Xg5cLp8x5FMQIYJKQKBCY8FC37AeJ5ffOhyEZ_yqg";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Create and initialize the storage buckets if they don't exist
const initializeBuckets = async () => {
  const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
  
  // Check if buckets exist or create them
  try {
    const buckets = ['pub_images', 'pub_audio', 'pub_documents'];
    
    for (const bucketName of buckets) {
      try {
        // Try to get the bucket info first
        const { data, error } = await supabase.storage.getBucket(bucketName);
        
        if (error) {
          if (error.message.includes('does not exist')) {
            console.log(`Bucket ${bucketName} doesn't exist, creating...`);
            const { data: bucketData, error: createError } = await supabase.storage.createBucket(bucketName, {
              public: true,
              fileSizeLimit: 50 * 1024 * 1024, // 50MB limit
              allowedMimeTypes: bucketName === 'pub_images' ? ['image/png', 'image/jpeg', 'image/gif', 'image/webp'] : undefined
            });
            
            if (createError) {
              console.error(`Error creating ${bucketName} bucket:`, createError);
            } else {
              console.log(`Created ${bucketName} bucket successfully`);
              
              // Configure CORS for the bucket
              const { error: corsError } = await supabase.storage.updateBucket(bucketName, {
                public: true,
                allowedMimeTypes: bucketName === 'pub_images' ? ['image/png', 'image/jpeg', 'image/gif', 'image/webp'] : undefined,
                fileSizeLimit: 50 * 1024 * 1024
              });
              
              if (corsError) {
                console.error(`Error configuring ${bucketName} bucket CORS:`, corsError);
              } else {
                console.log(`CORS configured for ${bucketName} bucket`);
              }
              
              // Add a public policy to the bucket
              // Note: getPublicUrl doesn't return an error property, only data
              const { data: publicUrlData } = await supabase.storage.from(bucketName).getPublicUrl('test');
              console.log(`Public policy for ${bucketName} is set up`);
            }
          } else {
            console.error(`Error checking ${bucketName} bucket:`, error);
          }
        } else {
          console.log(`Bucket ${bucketName} already exists`, data);
          
          // Verify bucket is public
          if (!data.public) {
            console.log(`Setting bucket ${bucketName} to public...`);
            const { error: updateError } = await supabase.storage.updateBucket(bucketName, {
              public: true,
              allowedMimeTypes: bucketName === 'pub_images' ? ['image/png', 'image/jpeg', 'image/gif', 'image/webp'] : undefined,
              fileSizeLimit: 50 * 1024 * 1024
            });
            
            if (updateError) {
              console.error(`Error updating ${bucketName} bucket to public:`, updateError);
            } else {
              console.log(`Successfully updated ${bucketName} bucket to public`);
            }
          }
        }
      } catch (err) {
        console.error(`Error handling ${bucketName} bucket:`, err);
      }
    }
    
    // Test image URL generation
    try {
      const { data: testUrlData } = await supabase.storage
        .from('pub_images')
        .getPublicUrl('test_image.png');
        
      console.log('Test public URL generation:', testUrlData.publicUrl);
    } catch (urlErr) {
      console.error('Error testing public URL:', urlErr);
    }
  } catch (error) {
    console.error('Error initializing storage buckets:', error);
  }
};

// Initialize buckets when the client is imported
initializeBuckets();

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
